{"version":3,"file":"EscrowLockCommand.js","sourceRoot":"","sources":["../../../../src/api/commands/escrow/EscrowLockCommand.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) 2017-2018, The Particl Market developers\n// Distributed under the GPL software license, see the accompanying\n// file COPYING or https://github.com/particl/particl-market/blob/develop/LICENSE\n\nimport { Logger as LoggerType } from '../../../core/Logger';\nimport { inject, named } from 'inversify';\nimport { validate, request } from '../../../core/api/Validate';\nimport { Types, Core, Targets } from '../../../constants';\nimport { RpcRequest } from '../../requests/RpcRequest';\nimport { Escrow } from '../../models/Escrow';\nimport { RpcCommandInterface } from '../RpcCommandInterface';\nimport { EscrowActionService } from '../../services/EscrowActionService';\nimport { OrderItemService } from '../../services/OrderItemService';\nimport { EscrowRequest } from '../../requests/EscrowRequest';\nimport { EscrowMessageType } from '../../enums/EscrowMessageType';\nimport { Commands} from '../CommandEnumType';\nimport { BaseCommand } from '../BaseCommand';\nimport { MessageException } from '../../exceptions/MessageException';\nimport * as _ from 'lodash';\nimport * as resources from 'resources';\nimport { BidMessageType } from '../../enums/BidMessageType';\nimport { OrderStatus } from '../../enums/OrderStatus';\n\nexport class EscrowLockCommand extends BaseCommand implements RpcCommandInterface<Escrow> {\n\n    public log: LoggerType;\n\n    constructor(\n        @inject(Types.Core) @named(Core.Logger) public Logger: typeof LoggerType,\n        @inject(Types.Service) @named(Targets.Service.EscrowActionService) private escrowActionService: EscrowActionService,\n        @inject(Types.Service) @named(Targets.Service.OrderItemService) private orderItemService: OrderItemService\n    ) {\n        super(Commands.ESCROW_LOCK);\n        this.log = new Logger(__filename);\n    }\n\n    /**\n     * data.params[]:\n     * [0]: orderItemId\n     * [1]: nonce\n     * [2]: memo\n     *\n     * @param data\n     * @returns {Promise<any>}\n     */\n    @validate()\n    public async execute( @request(RpcRequest) data: RpcRequest): Promise<any> {\n\n        const orderItemModel = await this.orderItemService.findOne(data.params[0]);\n        const orderItem = orderItemModel.toJSON();\n\n        // this.log.debug('orderItem:', JSON.stringify(orderItem, null, 2));\n\n        if (orderItem.status !== OrderStatus.AWAITING_ESCROW) {\n            this.log.error('Order is in invalid state');\n            throw new MessageException('Order is in invalid state');\n        }\n\n        const bid = orderItem.Bid;\n        if (!bid || bid.action !== BidMessageType.MPA_ACCEPT) {\n            this.log.error('No valid information to finalize escrow');\n            throw new MessageException('No valid information to finalize escrow');\n        }\n\n        const listingItem = orderItem.Bid.ListingItem;\n        if (_.isEmpty(listingItem)) {\n            this.log.error('ListingItem not found!');\n            throw new MessageException('ListingItem not found!');\n        }\n\n        const paymentInformation = orderItem.Bid.ListingItem.PaymentInformation;\n        if (_.isEmpty(paymentInformation)) {\n            this.log.error('PaymentInformation not found!');\n            throw new MessageException('PaymentInformation not found!');\n        }\n\n        const escrow = orderItem.Bid.ListingItem.PaymentInformation.Escrow;\n        if (_.isEmpty(escrow)) {\n            this.log.error('Escrow not found!');\n            throw new MessageException('Escrow not found!');\n        }\n\n        const escrowRatio = orderItem.Bid.ListingItem.PaymentInformation.Escrow.Ratio;\n        if (_.isEmpty(escrowRatio)) {\n            this.log.error('EscrowRatio not found!');\n            throw new MessageException('EscrowRatio not found!');\n        }\n\n        return this.escrowActionService.lock({\n            orderItem,\n            nonce: data.params[1],\n            memo: data.params[2],\n            action: EscrowMessageType.MPA_LOCK\n        } as EscrowRequest);\n\n    }\n\n    public usage(): string {\n        return this.getName() + ' [<itemhash> [<nonce> [<memo>]]] ';\n    }\n\n    public help(): string {\n        return this.usage() + ' -  ' + this.description() + '\\n'\n            + '    <orderItemId>            - String - The id of the OrderItem for which we want to lock the Escrow.\\n'\n            + '    <nonce>                  - String - The nonce of the Escrow.\\n'\n            + '    <memo>                   - String - The memo of the Escrow.';\n    }\n\n    public description(): string {\n        return 'Lock an Escrow.';\n    }\n\n}\n"]}